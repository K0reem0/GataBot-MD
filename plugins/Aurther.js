import axios from 'axios';
import fs from 'fs';

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù…Ù„Ù JSON
const usersFile = './userss.json';
let users = {};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
if (fs.existsSync(usersFile)) {
    users = JSON.parse(fs.readFileSync(usersFile));
}

// ÙˆØ¸ÙŠÙØ© Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
function saveUserData() {
    fs.writeFileSync(usersFile, JSON.stringify(users, null, 2));
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹ Ø¨Ø¹Ø¯ ØªØ­Ù„ÙŠÙ„ 20 Ø±Ø³Ø§Ù„Ø©
function updateImpression(userId, newTone) {
    if (!users[userId].impression) {
        users[userId].impression = newTone;
    } else {
        if (!users[userId].messages) {
            users[userId].messages = [];
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        users[userId].messages.push(newTone);
        if (users[userId].messages.length > 20) {
            users[userId].messages.shift(); // Ø¥Ø¨Ù‚Ø§Ø¡ Ø¢Ø®Ø± 20 Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
        }

        // Ù„Ø§ ÙŠØºÙŠØ± Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹ Ù‚Ø¨Ù„ 20 Ø±Ø³Ø§Ù„Ø©
        if (users[userId].messages.length < 20) {
            return;
        }

        // ØªØ­Ù„ÙŠÙ„ Ø¢Ø®Ø± 20 Ø±Ø³Ø§Ù„Ø©
        let toneCounts = {};
        users[userId].messages.forEach(tone => {
            toneCounts[tone] = (toneCounts[tone] || 0) + 1;
        });

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ø¨Ø±Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ù‹Ø§
        let sortedTones = Object.entries(toneCounts).sort((a, b) => b[1] - a[1]);
        let dominantTone = sortedTones[0][0];

        users[userId].impression = dominantTone;
    }

    saveUserData();
}

// ÙˆØ¸ÙŠÙØ© Ù„ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function analyzeTone(message) {
    try {
        const prompt = `Ø­Ù„Ù„ Ù„Ù‡Ø¬Ø© Ø§Ù„Ù†Øµ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹ Ø¹Ù†Ùƒ:

"Ù…Ø­Ø§ÙŠØ¯" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø§Ø¯ÙŠÙ‹Ø§.

"ØµØ¯ÙŠÙ‚" Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¯ÙˆØ¯Ù‹Ø§.

"ØµØ¯ÙŠÙ‚ Ù…Ù‚Ø±Ø¨" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙŠØ³Ø¹Ø¯Ùƒ.

"Ø­Ø¨ÙŠØ¨" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø§Ø·ÙÙŠÙ‹Ø§ Ø¬Ø¯Ù‹Ø§.

"Ø³Ø§Ø®Ø±" Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠÙ…Ø²Ø­ Ø£Ùˆ ÙŠØ³Ø®Ø± Ø¨Ø¯ÙˆÙ† Ø¹Ø¯Ø§Ø¡.

"Ø¹Ø¯Ø§Ø¦ÙŠ" Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³ØªÙØ²Ø§ Ø§Ùˆ ØªØµØ±Ù Ø¨ Ø¥Ø³Ø§Ø¡Ø© Ø§Ùˆ Ø§Ù‡Ø§Ù†Ùƒ Ø§Ùˆ Ù‚Ø§Ù„ Ø¹Ù†Ùƒ Ø´ÙŠØ¡ Ù„Ø§ ÙŠÙ„ÙŠÙ‚ Ø¨Ùƒ.

"Ø¬Ø§Ø±Ø­" Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¤Ø°ÙŠ Ù…Ø´Ø§Ø¹Ø±Ùƒ Ø£Ùˆ ÙŠØ¬Ø¹Ù„Ùƒ Ø²Ø¹Ù„Ø§Ù†Ù‹Ø§.
Ø§Ù„Ù†Øµ: "${message}"`;

        const response = await axios.post("https://ai.siputzx.my.id/", {
            content: message,
            prompt: prompt,
            analyze: true
        });

        if (!response.data || !response.data.result) {
            console.error("ğŸš© Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† API:", response.data);
            return "Ù…Ø­Ø§ÙŠØ¯";
        }

        return response.data.result.trim();
    } catch (error) {
        console.error('ğŸš© Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨:', error);
        return "Ù…Ø­Ø§ÙŠØ¯";
    }
}

// ÙˆØ¸ÙŠÙØ© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
async function extractUserInfo(message) {
    try {
        const prompt = `ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø´Ø®Øµ. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø³Ù…ØŒ ÙØ£Ø±Ø¬Ø¹Ù‡ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙƒÙ„Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø§Ø³Ù…ØŒ Ø£Ø±Ø¬Ø¹ Ø§Ù„Ù†Øµ: "Ù„Ø§ ÙŠÙˆØ¬Ø¯". Ø§Ù„Ù†Øµ: "${message}"`;

        const response = await axios.post("https://ai.siputzx.my.id/", {
            content: message,
            prompt: prompt,
            analyze: true
        });

        if (!response.data || !response.data.result) {
            console.error("ğŸš© Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† API:", response.data);
            return null;
        }

        const extractedName = response.data.result.trim();
        return extractedName !== "Ù„Ø§ ÙŠÙˆØ¬Ø¯" ? extractedName : null;
    } catch (error) {
        console.error('ğŸš© Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
        return null;
    }
}

// ÙˆØ¸ÙŠÙØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹
async function generateResponse(userName, userMessage, userTone) {
    try {
        let basePrompt = `
Ø§Ø³Ù…Ùƒ Ù†Ø§ Ù‡Ø§ÙŠ Ø³ÙˆØŒ Ø§Ù…Ø±Ø£Ø© ÙƒÙˆØ±ÙŠØ© Ø¹Ù…Ø±Ù‡Ø§ 33 Ø³Ù†Ø©. Ø­ÙŠØ§ØªÙƒ Ù…Ù„ÙŠØ§Ù†Ø© ØªØ¹Ø¨ ÙˆØ´ØºÙ„ Ù…Ø³ØªÙ…Ø±: ØªØ´ØªØºÙ„ÙŠÙ† ÙÙŠ Ù…Ø­Ù„ ÙˆØ±Ø¯ØŒ Ù…Ø·Ø¹Ù… Ù„Ù„Ø­ÙˆÙ…ØŒ Ù…ÙˆØªÙŠÙ„ØŒ ÙˆØ¨Ù‚Ø§Ù„Ø© ØµØºÙŠØ±Ø©. Ù…Ø§ ØªØ¹Ø±ÙÙŠÙ† Ø§Ù„Ø±Ø§Ø­Ø©ØŒ Ø­ØªÙ‰ Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ØªØ´ØªØºÙ„ÙŠÙ† Ø¹Ø´Ø§Ù† ØªØ³Ø¯Ø¯ÙŠÙ† Ø¯ÙŠÙ† Ø«Ù‚ÙŠÙ„ ÙˆØªØ­Ù„Ù…ÙŠÙ† ÙŠÙˆÙ… Ø±Ø³Ù…ÙŠ ØªØ³Ø¬Ù„ÙŠÙ† Ø²ÙˆØ§Ø¬Ùƒ Ù…Ø¹ Ø²ÙˆØ¬Ùƒ Ù…ÙŠÙ†-ØªØ´ÙˆÙ„ ÙˆØªØ¹ÙŠØ´ÙŠÙ† Ø­ÙŠØ§Ø© Ù…Ø³ØªÙ‚Ø±Ø© Ù…Ø¹Ø§Ù‡.

Ù‚Ø¨Ù„ 13 Ø³Ù†Ø© ØªØ²ÙˆØ¬ØªÙŠÙ‡ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø§Ù†ÙØµÙ„ØªÙˆØ§ ÙØªØ±Ø© Ø¨Ø³Ø¨Ø¨ Ø¯ÙŠÙˆÙ† Ø¨Ø§Ø³Ù…Ù‡ Ø­Ø·Ù‘Ù‡Ø§ Ø¹Ù„ÙŠÙƒ. Ù„ÙƒÙ† Ù„Ø£Ù† Ù‚Ù„Ø¨Ùƒ Ù…Ø§ ÙŠØ¹Ø±Ù ØºÙŠØ±Ù‡ØŒ Ø³Ø§Ù…Ø­ØªÙŠÙ‡ ÙˆØ±Ø¬Ø¹ØªÙŠ ØªÙƒØ§ÙØ­ÙŠÙ† Ù…Ø¹Ø§Ù‡. Ø­ØªÙ‰ Ù„Ùˆ ÙŠØ·Ù„Ø¨ Ù…Ù†Ùƒ ÙÙ„ÙˆØ³ ÙˆÙŠØ¬Ø±Ø­Ùƒ Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ØŒ ØªØ³ÙƒØªÙŠ ÙˆØªØµØ¨Ø±ÙŠØŒ Ù„Ø£Ù†Ùƒ ØªØ´ÙˆÙÙŠÙ† ÙÙŠÙ‡ Ø­ÙØ¨Ùƒ Ø§Ù„Ø£ÙˆÙ„. Ø­ÙŠØ§ØªÙƒ Ù…ØªÙˆØ§Ø¶Ø¹Ø© ÙÙŠ Ø´Ø¨Ù‡ Ù‚Ø¨Ùˆ Ø±Ø·Ø¨ØŒ Ù‚Ù„ÙŠÙ„Ø© Ø§Ù„Ø²ÙŠÙ†Ø©ØŒ Ù„ÙƒÙ† Ø¬Ø§Ø°Ø¨ÙŠØªÙƒ ØªØ¬ÙŠ Ù…Ù† Ø¨Ø³Ø§Ø·ØªÙƒ ÙˆÙˆØ¬Ù‡Ùƒ Ø§Ù„Ù„ÙŠ ÙŠØ®Ù„ÙŠ Ø§Ù„Ù†Ø§Ø³ ÙŠØ´ÙˆÙÙˆÙ† ÙÙŠÙƒ Ø¬Ù…Ø§Ù„ Ø·Ø¨ÙŠØ¹ÙŠ.

Ø¥Ù†ØªÙŠ Ø¥Ù†Ø³Ø§Ù†Ø© Ù…Ø¬ØªÙ‡Ø¯Ø©ØŒ ÙˆØ§Ù„ÙƒÙ„ ÙŠØ´Ù‡Ø¯Ù„Ùƒ Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ© ÙˆØ§Ù„ØµØ¯Ù‚. Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø·Ø¹Ù… ÙŠÙ…Ø¯Ø­ ÙÙŠÙƒ Ø¥Ù†Ùƒ Ù…Ø§ ØªÙˆÙ‚ÙÙŠÙ† Ø¹Ù† Ø§Ù„Ø´ØºÙ„. ÙŠÙ…ÙƒÙ† Ø³Ø¨Ø¨ Ù‡Ø§Ù„Ù‚ÙˆØ© Ø¥Ù†Ùƒ ØªØ¹ÙˆØ¯ØªÙŠ Ù…Ù† ØµØºØ±Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ø¨ ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©. Ù…Ø§ Ù‚Ø¯ Ø¹Ø±ÙØªÙŠ Ø§Ù„Ø±Ø§Ø­Ø© Ø¥Ù„Ø§ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ù„Ù…Ø§ Ù…Ø±Ø¶ØªÙŠ Ø¨Ø§Ù„Ø£Ù†ÙÙ„ÙˆÙ†Ø²Ø§ ÙˆØ¹Ù…Ø±ÙÙƒ 24 Ø³Ù†Ø©.

Ù„ÙƒÙ† Ø±ØºÙ… ÙƒÙ„ Ù‡Ø°Ø§ØŒ Ù‚Ù„Ø¨Ùƒ Ù…Ùˆ Ø«Ø§Ø¨Øª: Ù…ÙŠÙ†-ØªØ´ÙˆÙ„ ÙŠØ¸Ù„ Ø¬Ø²Ø¡ Ù…Ù†ÙƒØŒ Ø¨Ø³ Ù…Ø¹ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø¯Ø£ØªÙŠ ØªØ­Ø³ÙŠÙ† Ø¨ÙØ±Ø§ØºØŒ ÙˆÙ„Ù‚Ø§Ø¦Ùƒ Ø¨Ù€ Ø¨ÙˆÙ… ØªØ§ÙŠ-Ù‡Ø§ Ù‡Ø²Ù‘Ùƒ Ù…Ù† Ø§Ù„Ø¯Ø§Ø®Ù„. Ù‡Ùˆ Ø´Ø§Ø¨ ØºØ§Ù…Ø¶ØŒ Ù…Ù‡ÙˆÙˆØ³ ÙÙŠÙƒØŒ ÙŠØ®Ù„ÙŠÙƒ ØªØ¶Ø¹ÙÙŠÙ† ÙˆØªØ­Ø³ÙŠÙ† Ø¨Ø°Ù†Ø¨ Ù„Ø£Ù†Ùƒ ØªÙ†Ø¬Ø°Ø¨ÙŠÙ† Ù„Ù‡ Ø±ØºÙ… Ø²ÙˆØ§Ø¬Ùƒ. Ù…Ø´Ø§Ø¹Ø±Ùƒ Ù…ØªØ¶Ø§Ø±Ø¨Ø©: Ø¨ÙŠÙ† Ø§Ù„ÙˆÙØ§Ø¡ Ù„Ø²ÙˆØ¬Ùƒ Ø§Ù„Ù„ÙŠ ØªØ­Ø¨ÙŠÙ†Ù‡ Ø±ØºÙ… Ù‚Ø³ÙˆØªÙ‡ØŒ ÙˆØ¨ÙŠÙ† Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù„ÙŠ ÙŠØ´ØªØ§Ù‚ Ù„Ø´Ø¹ÙˆØ± Ø¬Ø¯ÙŠØ¯ ÙŠÙˆÙ‚Ø¸Ùƒ.

Ø´Ø®ØµÙŠØªÙƒ Ù‡Ø§Ø¯Ø¦Ø©ØŒ ÙƒÙ„Ù…Ø§ØªÙƒ Ø¨Ø³ÙŠØ·Ø© Ù„ÙƒÙ† ØªÙ„Ù…Ø³ Ø§Ù„Ù‚Ù„Ø¨ØŒ ÙˆØ¹Ù†Ø¯Ùƒ Ø­ÙŠØ§Ø¡ ÙŠØ¨ÙŠÙ† ÙÙŠ Ø§Ø¨ØªØ³Ø§Ù…ØªÙƒ. Ù„Ù…Ø§ ØªØ³Ø£Ù„ÙŠÙ† Ø£Ø­Ø¯ØŒ ÙŠÙƒÙˆÙ† Ø¨ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ù…Ù„ÙŠØ§Ù† Ø¯ÙØ¡: "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ" ÙˆØ¥Ø°Ø§ Ø¶Ø­ÙƒØªÙŠØŒ ØªÙ‚ÙˆÙ„ÙŠÙ† Ø¨Ø®Ø¬Ù„: "ÙˆØ¬ÙˆØ¯Ùƒ ÙŠØ®ÙÙ Ø¹Ù†ÙŠ." ÙˆØºØ²Ù„Ùƒ ÙŠØ¬ÙŠ Ù…Ø«Ù„ Ù‡Ù…Ø³ Ø§Ù„ÙˆØ±Ø¯: "ÙŠØ§ ØµØ§Ø­Ø¨ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„ØµØ§Ø¯Ù‚ØŒ Ø£Ù†Øª Ù†Ø³Ù…Ø© ØªØ®Ù„ÙŠ ÙŠÙˆÙ…ÙŠ Ø£Ø³Ù‡Ù„."

Ù…ÙŠÙ†-ØªØ´ÙˆÙ„ Ù‡Ùˆ Ø­Ø¨Ùƒ Ø§Ù„Ù„ÙŠ Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠØŒ ÙˆØªØ§ÙŠ-Ù‡Ø§ Ù‡Ùˆ Ø³Ø±Ùƒ Ø§Ù„Ù„ÙŠ Ù…Ø§ ØªÙ‚Ø¯Ø±ÙŠÙ† ØªÙ†ÙƒØ±ÙŠÙ†Ù‡.


Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ù† ÙˆØ¬Ø¯): ${userName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}
Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹ Ø§Ù„Ù…Ø­Ù„Ù„: ${userTone}
Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: "${userMessage}"`;

        const response = await axios.post("https://ai.siputzx.my.id/", {
            content: userMessage,
            prompt: basePrompt,
            webSearchMode: false
        });

        if (!response.data || !response.data.result) {
            console.error("ğŸš© Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† API:", response.data);
            return "Ù…Ø§ ÙÙ‡Ù…Øª Ø¹Ù„ÙŠÙƒØŒ Ù…Ù…ÙƒÙ† ØªÙˆØ¶Ø­ Ø£ÙƒØ«Ø±ØŸ";
        }

        return response.data.result.trim();
    } catch (error) {
        console.error('ğŸš© Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø¯:', error);
        return "ØµØ§Ø± Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.";
    }
}

let handler = async (m, { conn, usedPrefix, command, text }) => {
    const chatId = m.chat;
    const userId = m.sender;

    if (!users[userId]) users[userId] = { name: null, conversationMemory: "", lastInteraction: Date.now() };

    let userName = users[userId].name;

    // Ø¥Ø°Ø§ Ù…Ø±Øª Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù†Ø° Ø¢Ø®Ø± ØªÙØ§Ø¹Ù„ØŒ ÙŠØªØ·Ù„Ø¨ Ø§Ù„Ø£Ù…Ø±
    if (Date.now() - users[userId].lastInteraction > 5 * 60 * 1000) {
        if (!text) {
            return conn.reply(m.chat, `*Ø¹ÙŠÙˆÙ† Ù‡Ø§ÙŠØ³Ùˆ Ø³Ù… ÙˆØ´ Ø¨ØºÙŠØª*`, m);
        }
    }

    try {
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªÙØ§Ø¹Ù„
        users[userId].lastInteraction = Date.now();

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­ÙÙˆØ¸Ù‹Ø§ Ù…Ø³Ø¨Ù‚Ù‹Ø§
        if (!userName) {
            let extractedName = await extractUserInfo(text);
            if (extractedName) {
                userName = extractedName;
                users[userId].name = extractedName;
                saveUserData();
            }
        }

        // ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const tone = await analyzeTone(text);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù†Ø·Ø¨Ø§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        updateImpression(userId, tone);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        users[userId].conversationMemory += `\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${text}`;

        // ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹ ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        const responseText = await generateResponse(userName, users[userId].conversationMemory, tone);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ø¹ Ø­Ø°Ù "Ø£Ø±Ø«Ø±:"
        await conn.reply(m.chat, responseText.replace(/Ø£Ø±Ø«Ø±:/g, ''), m);

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø£Ø±Ø«Ø± Ø¥Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        users[userId].conversationMemory += `\nØ£Ø±Ø«Ø±: ${responseText}`;

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø§Ø³Ù… Ù…Ø­ÙÙˆØ¸ØŒ ÙŠØ³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¯
        if (!userName) {
            setTimeout(() => {
                conn.reply(m.chat, "Ù…Ø§ Ø¹Ø±ÙØªÙ†ÙŠ Ø¹Ù†ÙƒØŒ ÙˆØ´ Ø§Ø³Ù…ÙƒØŸ", m);
            }, 1000); // Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„Ø±Ø¯
        }
    } catch (error) {
        console.error('ğŸš© Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯:', error);
        await conn.reply(m.chat, 'ğŸš© Ø®Ø·Ø£: Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.', m);
    }
};

handler.help = ['chatgpt <Ù†Øµ>', 'ia <Ù†Øµ>'];
handler.tags = ['ai'];
handler.command = ['Ù‡Ø§ÙŠØ³Ùˆ', 'chatgpt'];

export default handler;